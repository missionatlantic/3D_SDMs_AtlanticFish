---
title: "HS Mean maps by species"
author: "M Valle"
date: "08/6/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warming = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # to set up the root directory to the R project path. otherwise knitr uses the path of the markdown document as root directory
```

#Script information

With this script we calculate the 0.99 quantile of the depth distribution for each species and generate bricks that contain 47 layers but from the quantile depth the values are NA. 

Loading libraries
```{r}
library(sf)
library(rgdal)
library(stringr)
library(tidyverse)
library(ggpubr)
library(hrbrthemes) # theme_ipsum
library(readxl)
```

# creating a vector with the depth layers value
```{r}
load(here::here ("data", "raw_data", "variables", "DEPTH", "depth.RData"))

d <- as.numeric (depth)
```

#Loading selected species for modelling 
```{r}

species <- read.csv (here::here ("data", "derived_data","outputs_for_modelling", "species_for_modelling.csv"),  sep = ",")

species <- species %>% 
  dplyr:: select ( -X) 

names <- read_excel (here::here ("data", "derived_data", "01_species_catches", "fish_and_tuna_long_list_75_Atlantic.xlsx"))

filenames_sp <- names$TaxonName


head(names)


n <- data.frame(species$SP)

names(n)

n <- n %>% 
  dplyr::rename (id = "species.SP")

n <- str_remove(n$id, "SP")

n <- as.numeric (n)

```

Create an empty df to save the depth quantile information 
```{r}
max_depth_for_hsm_quantile <- as.data.frame(matrix(NA, ncol = 3 ,nrow = 76))
```

Loop by species where we calculate the depth level of the 99 quantile of the occurrences and then select the HS map from 0 to that level and we add NA values to all other layer depth and export as raster brick.
```{r}
for(i in n ){
  
  print(i)
  
  #calculate depth limit
  #Load SP data
  load(file.path("data", "derived_data","outputs_for_modelling","pa_environment", paste0("SP",i,".Rdata")))
  
  occ<-get(paste0("SP",i), env = new.env())
  
  occ <- occ %>% 
    dplyr::filter (status == 1) %>% 
    dplyr::select (lon, lat, depth, status) %>% 
    dplyr::rename (x = "lon", 
            y = "lat")
  
  myquantile <- quantile(occ$depth, probs = .99)
  
  myquantile <- as.numeric(myquantile)
  
  #load HSM map 
  HSM_brick <- brick (here::here ("data", "derived_data","models_sp00001", "rasters_set_by_species", "bricks", paste0("HSM_brick_SP",i,".tif")))
  
  #### Transforming from stack to table
  HSM_brick_df <- as.data.frame(HSM_brick, xy=TRUE)

  # assign names
  names (HSM_brick_df) <- c("x",
                          "y", 
                           "0", 
                           "5", 
                           "10",
                           "15", 
                           "20", 
                           "25",
                           "30", 
                           "35", 
                           "40", 
                           "45", 
                           "50", 
                           "55",
                           "60", 
                           "65",  
                           "70",
                           "75", 
                           "80", 
                           "85", 
                           "90", 
                           "95", 
                           "100",  
                           "125", 
                           "150", 
                           "175", 
                           "200", 
                           "225",  
                           "250", 
                           "275",  
                           "300", 
                           "325", 
                           "350",
                           "375", 
                           "400", 
                           "425", 
                           "450", 
                           "475", 
                           "500", 
                           "550", 
                           "600", 
                           "650", 
                           "700", 
                           "750", 
                           "800",
                           "850", 
                           "900", 
                           "950",
                           "1000")
  
  
  #create a vector that includes the columns <= to the calculated quantile
  cols_select <- as.data.frame (d) %>% 
    dplyr::filter (d <= myquantile)
  
  cols_select <- as.character(cols_select$d)
    
  ## filter the HSM_brick dataframe considering calculated myquantile
  HSM_brick_df_subset <-  HSM_brick_df %>% 
   dplyr::select(c(x, y, all_of(cols_select))) 
  
#---------------------------------------------------------------------------#  
#2) create a new data frame to add layers with NA value until 1000 m 
#---------------------------------------------------------------------------#
new_df <- matrix(NA, ncol = 47, nrow = nrow (HSM_brick_df))

colnames(new_df) <- c(     "depth_0", 
                           "depth_5", 
                           "depth_10",
                           "depth_15", 
                           "depth_20", 
                           "depth_25",
                           "depth_30", 
                           "depth_35", 
                           "depth_40", 
                           "depth_45", 
                           "depth_50", 
                           "depth_55",
                           "depth_60", 
                           "depth_65",  
                           "depth_70",
                           "depth_75", 
                           "depth_80", 
                           "depth_85", 
                           "depth_90", 
                           "depth_95", 
                           "depth_100",  
                           "depth_125", 
                           "depth_150", 
                           "depth_175", 
                           "depth_200", 
                           "depth_225",  
                           "depth_250", 
                           "depth_275",  
                           "depth_300", 
                           "depth_325", 
                           "depth_350",
                           "depth_375", 
                           "depth_400", 
                           "depth_425", 
                           "depth_450", 
                           "depth_475", 
                           "depth_500", 
                           "depth_550", 
                           "depth_600", 
                           "depth_650", 
                           "depth_700", 
                           "depth_750", 
                           "depth_800",
                           "depth_850", 
                           "depth_900", 
                           "depth_950",
                           "depth_1000")

myfirstcolumn <- (length(HSM_brick_df_subset) - 2) + 1

new_df <- as.data.frame(new_df) %>% 
  dplyr::select (c(all_of(myfirstcolumn):47))

data.df <- cbind (HSM_brick_df_subset,new_df )

colnames(data.df)<-c( "x", "y",
                          "depth_0", 
                           "depth_5", 
                           "depth_10",
                           "depth_15", 
                           "depth_20", 
                           "depth_25",
                           "depth_30", 
                           "depth_35", 
                           "depth_40", 
                           "depth_45", 
                           "depth_50", 
                           "depth_55",
                           "depth_60", 
                           "depth_65",  
                           "depth_70",
                           "depth_75", 
                           "depth_80", 
                           "depth_85", 
                           "depth_90", 
                           "depth_95", 
                           "depth_100",  
                           "depth_125", 
                           "depth_150", 
                           "depth_175", 
                           "depth_200", 
                           "depth_225",  
                           "depth_250", 
                           "depth_275",  
                           "depth_300", 
                           "depth_325", 
                           "depth_350",
                           "depth_375", 
                           "depth_400", 
                           "depth_425", 
                           "depth_450", 
                           "depth_475", 
                           "depth_500", 
                           "depth_550", 
                           "depth_600", 
                           "depth_650", 
                           "depth_700", 
                           "depth_750", 
                           "depth_800",
                           "depth_850", 
                           "depth_900", 
                           "depth_950",
                           "depth_1000")
  
summary(data.df)  

 #transform to raster
 data.df.r <- rasterFromXYZ(data.df)
 
 # Save raster
 writeRaster(data.df.r,
             filename=here::here ("data", "derived_data", "models_sp00001", "rasters_set_by_species","HSM_quantile", paste0("HSM_quantile_SP_", i,".tif")),
             format="GTiff",
             overwrite=TRUE)
  
  #write table 
  max_depth_for_hsm_quantile [i, ] <- data.frame(paste0("SP",i),
                               filenames_sp[i],
                               myquantile)
  
}# end of loop

names(max_depth_for_hsm_quantile) <- c("SP", "SN", "quantile_depth")

max_depth_for_hsm_quantile <- max_depth_for_hsm_quantile %>% 
  drop_na(SP)

write.csv(max_depth_for_hsm_quantile, file=here::here ("data", "derived_data", "models_sp00001", "max_depth_for_hsm_quantile.csv"))  
    
```

