---
title: "catches_2_probability"
author: "M Valle"
date: "31/5/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warming = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # to set up the root directory to the R project path. otherwise knitr uses the path of the markdown document as root directory
```

#Script information

With this script load HSM maps where NAs has been assigned to those layer depths deeper than the 0.99 quantile depth, then we mask the projections to the Atlantic division that corresponds to each species to finally save the masked maps. 

Loading libraries
```{r}
library(sf)
library(rgdal)
library(stringr)
library(tidyverse)
library(ggpubr)
library(hrbrthemes) # theme_ipsum
library(raster) #read brick
library(prevR)#point.in.SpatialPolygons
library(readxl)
```

# Loading Atlantic division 

```{r}
atl_division_df <- read.csv (here::here ("data", "derived_data", "Atlantic_division", "n_counts_df_division.csv"),  sep = ",")

```

#Loading selected species for modelling 
```{r}
species <- read.csv (here::here ("data", "derived_data","outputs_for_modelling", "species_for_modelling.csv"),  sep = ",")

species <- species %>% 
  dplyr:: select ( -X) 

names <- read_excel (here::here ("data", "derived_data", "01_species_catches", "fish_and_tuna_long_list_75_Atlantic.xlsx"))

filenames_sp <- names$TaxonName


head(names)

n <- data.frame(species$SP)

names(n)

n <- n %>% 
  dplyr::rename (id = "species.SP")

n <- str_remove(n$id, "SP")

n <- as.numeric (n)

```

# Loading FAO east and FAO west polygons
```{r}

#FAO east

#Load FAO shapefile
FAO_east<- readOGR(here::here("data", "raw_data", "FAO_AREAS", "FAO_Atlantic_EAST.shp"))

# Ploting FAO regions
plot(FAO_east)

#FAO west

#Load FAO shapefile
FAO_west<- readOGR(here::here("data", "raw_data", "FAO_AREAS", "FAO_Atlantic_WEST.shp"))

# Ploting FAO regions
plot(FAO_west)

```

#Load species list
```{r}
for(i in n){
  
  print(i)
  
  # select the division associated to my sp
  mySP <- atl_division_df %>% 
          filter (atl_division_df$SP == paste0("SP", i))
  #load HSM brick 
  HSM_brick <- brick (here::here ("data", "derived_data", "models_sp00001", "rasters_set_by_species","HSM_quantile", paste0("HSM_quantile_SP_", i,".tif")))
  
  #plot(HSM_brick)
  
  #### Transforming from stack to table
  HSM_brick_df <- as.data.frame(HSM_brick, xy=TRUE)
  
  summary(HSM_brick_df)

  
  names (HSM_brick_df) <- c("x",
                          "y", 
                           "hs_0", 
                           "hs_5", 
                           "hs_10",
                           "hs_15", 
                           "hs_20", 
                           "hs_25",
                           "hs_30", 
                           "hs_35", 
                           "hs_40", 
                           "hs_45", 
                           "hs_50", 
                           "hs_55",
                           "hs_60", 
                           "hs_65",  
                           "hs_70",
                           "hs_75", 
                           "hs_80", 
                           "hs_85", 
                           "hs_90", 
                           "hs_95", 
                           "hs_100",  
                           "hs_125", 
                           "hs_150", 
                           "hs_175", 
                           "hs_200", 
                           "hs_225",  
                           "hs_250", 
                           "hs_275",  
                           "hs_300", 
                           "hs_325", 
                           "hs_350",
                           "hs_375", 
                           "hs_400", 
                           "hs_425", 
                           "hs_450", 
                           "hs_475", 
                           "hs_500", 
                           "hs_550", 
                           "hs_600", 
                           "hs_650", 
                           "hs_700", 
                           "hs_750", 
                           "hs_800",
                           "hs_850", 
                           "hs_900", 
                           "hs_950",
                           "hs_1000")
  

#------------------------------------------------------------------#  
# Mask to corresponding Atlantic division  
#-------------------------------------------------------------------#
 
    ## create a myvariables object containing the names of the variables
    myvars <- HSM_brick_df %>% 
    dplyr::select(-c(1:2))
    
    myvars <- names (myvars)
    
  if (mySP$division=="north-east"){

#EAST filter
    
#create a TRUE/FALSE object where TRUE means that the points is inside the FAO east polygon and FALSE that it is outside
data_new <- point.in.SpatialPolygons(HSM_brick_df$x, HSM_brick_df$y, FAO_east)

#add the TRUE/FALSE object to the dataframe
data_check <- cbind (HSM_brick_df, data_new)

# assign NA value to those points outside the corresponding FAO division, if data_new column says TRUE then we keep the value if it says FALSE then we assign NA
data.df <- data_check %>% 
  dplyr::mutate_at(.vars = myvars, funs(ifelse(data_new == TRUE, ., NA)))

    
  data.df <- data.df %>% 
      dplyr::select (-data_new)

#NORTH filter

# assign NA value to those points with a lat value under 0, if y column data is > 0 then we keep the value if it < 0 then we assign NA
data.df <- data.df %>% 
  dplyr::mutate_at(.vars = myvars, funs(ifelse(y > 0, ., NA)))

# ggplot() +
#   geom_point(data = data.df, aes(x=x, y=y, colour = redistributed_catches_by_depth_brick_SP1.21), size = 1, alpha = 0.4)

  }
  
  if (mySP$division=="north"){

#NORTH filter

# assign NA value to those points with a lat value under 0, if y column data is > 0 then we keep the value if it < 0 then we assign NA
data.df <- HSM_brick_df %>% 
  dplyr::mutate_at(.vars = myvars, funs(ifelse(y > 0, ., NA)))


# ggplot() +
#   geom_point(data = data.df, aes(x=x, y=y, colour = redistributed_catches_by_depth_brick_SP1.21), size = 1)

  }
  
  if (mySP$division=="east"){

  # EAST filter

#create a TRUE/FALSE object where TRUE means that the points is inside the FAO east polygon and FALSE that it is outside
data_new <- point.in.SpatialPolygons(HSM_brick_df$x, HSM_brick_df$y, FAO_east)

#add the TRUE/FALSE object to the dataframe
data_check <- cbind (HSM_brick_df, data_new)

# assign NA value to those points outside the corresponding FAO division, if data_new column says TRUE then we keep the value if it says FALSE then we assign NA
data.df <- data_check %>% 
  dplyr::mutate_at(.vars = myvars, funs(ifelse(data_new == TRUE, ., NA)))

    
    data.df <- data.df %>% 
      dplyr::select (-data_new)


# ggplot() +
#     geom_point(data = data.df, aes(x=x, y=y, colour = depth_0), size = 1, alpha = 0.4)

  }
  #pan-atlantic
  if (mySP$division=="pan-atlantic"){
  
data.df <- HSM_brick_df

  }
    
#----------------------------------------------------------#
# Create a raster from the dataframe
#------------------------------------------------------------#    

    #transform to raster
    HSM_brick_masked.r <- rasterFromXYZ(data.df)
    
    plot(HSM_brick_masked.r)
#------------------------------------------------------------#     
#save brick
#------------------------------------------------------------# 
    
    writeRaster(HSM_brick_masked.r,
            filename=here::here ("data", "derived_data", "models_sp00001", "rasters_set_by_species", "HSM_masked_quantile_atl_division", paste0("HSM_masked_quantile_atl_division_SP",i)),
             format="GTiff",
             overwrite=TRUE,
             options=c("INTERLEAVE=BAND","COMPRESS=LZW"))
    
    
}# end of loop

```

