---
title: "Mapping catches sum along the water column"
author: "Mireia Valle"
date: "17/2/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warming = FALSE)
```

### Script information

With this script we sum up catches from 25 top commercial fish species along the water column that results in a map where we can see the most productive areas of the Atlantic Ocean.

Project: IM-20-MISSION

### Loading required libraries
```{r}
library (dplyr)
library(raster) # package for raster manipulation
library(MALDIquant)
library(rgdal)
library(plotly)
library(here)
library(tidyverse)
library(reshape2)
library(sf)
library(prevR)
library(gtools) #mixedsort
library(maps)        # some basic country maps
library(mapdata)     # higher resolution maps
library(marmap)      # access global topography data
library(metR)
library(ggpubr)
library(readxl)
```

### Load species SPid and names
```{r}

species <- read.csv (here::here ("data", "derived_data","outputs_for_modelling","species_for_modelling.csv"),  sep = ",")
 
species <- species %>% 
   dplyr:: select (-X) 

names <- read_excel (here::here ("data", "derived_data", "01_species_catches", "fish_and_tuna_long_list_75_Atlantic.xlsx"))

filenames_sp <- names$TaxonName

head(names)

```

# Data for validation of the sum
```{r}
sum_catches_redistributed <- read.csv(here::here ("data", "derived_data", "models_sp00001", "sum_catches_redistributed.csv"))

```

# Create a data frame with xy coordinates and another new_df that where we will paste all species catches value by cell
```{r}
#load sum catches map and rename the sum catches column
template <- raster(here::here ("data", "derived_data","models_sp00001", "rasters_set_by_species", "catches_sum_atl_div", paste0("catches_sum_SP34.tif")))

template.df <- as.data.frame(template, xy=TRUE)

summary(template.df)

xy_sum<- template.df %>% 
  dplyr::select (c(x, y))

new_df <- matrix(NA, ncol = 76, nrow = nrow(xy_sum))

```

First we want to work with fish species, excluding the tuna species
```{r}
n <- c(11, 1,  2,  3,  5,  6,  8,  9, 10, 19, 21, 22, 23, 30, 31, 35, 36, 37, 38, 42, 50, 53, 61, 66, 71)

for (i in n) {

#load sum catches map and rename the sum catches column
sum_catches <- raster(here::here ("data", "derived_data", "models_sp00001", "rasters_set_by_species", "catches_sum_atl_div", paste0("catches_sum_SP", i, ".tif")))

sum_catches.df <- as.data.frame(sum_catches, xy=TRUE)

sum_catches.df <- sum_catches.df %>% 
  dplyr::rename (sum_catches = paste0("catches_sum_SP", i))

#add mean values to the validation summary table

new_df [,i] <- sum_catches.df$sum_catches


}


#Prepare all catches sum table 

new_df_clean <- as.data.frame(new_df)

new_df_clean <- new_df_clean %>% 
  dplyr::select_if(~!all(is.na(.))) 

colnames(new_df_clean) = gsub("V", "SP", colnames(new_df_clean))

new_df_clean <- new_df_clean %>% 
  dplyr::mutate(all_sum = rowSums(.))


all_catches_sum.df <- cbind (xy_sum, new_df_clean)

summary(all_catches_sum.df)

write.csv(all_catches_sum.df, 
          file=here::here ("data", "derived_data", "models_sp00001", "catches", "25SPECIES_catches_sum.df.csv"), 
          row.names=FALSE)

# Transform to raster

all_catches_sum.df <- all_catches_sum.df %>% 
  dplyr::select (c(x, y, all_sum))

all_catches_sum <- rasterFromXYZ(all_catches_sum.df)


#Plotting ---------------------------------------------------------------

# basic map data

global <- map_data("worldHires")

# transforming 0's in NAs

all_catches_sum.df [, 3][all_catches_sum.df [, 3] == 0] <- NA 

summary (all_catches_sum.df)

p <- ggplot() +
  geom_point(data = all_catches_sum.df, aes(x = x, y = y, colour = all_sum), size = 1)+
    scale_colour_distiller(name = paste("Catches (tons/year)"), 
                           palette = "YlOrRd", direction = +1, 
                           limits = c(min(all_catches_sum.df$all_sum), max(all_catches_sum.df$all_sum)), na.value="transparent")+
    labs(fill = "")  +
  theme_pubclean(base_size = 22)+
  annotation_map(map=global, fill="#999999")+
  scale_y_latitude(limits = c(-80, 80))+
  scale_x_longitude(limits = c(-100,60, ticks = 50))+
    theme(panel.background = element_blank(),
          #text = element_text(size = 22),
          #axis.text.x = element_blank(), 
          #axis.ticks.x = element_blank(),
          legend.position="right")+
    # title
    labs(y="Latitude" 
         ,x = "Longitude")

ggsave(filename= "25SPECIES_catches.tif", plot=p, device="tiff",
         path=here::here ("product", "figures", "catches"), 
         height=22, width=26, 
         units="in", dpi=600)   
```

