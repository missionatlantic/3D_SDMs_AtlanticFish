---
title: "01_scam"
author: "Guillem Chust, Leire Ibaibarriaga, Leire Citores, Eduardo Ramirez-Romero & Mireia Valle"
date: "2023-09-20"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warming = FALSE)
```

### Script information

With this script we generate a sc-gam models for each species and we save them

### Loading required libraries

```{r}
library(scam)
#library(mgcv)
library(plotmo)
library(rgdal)
library(ggplot2)
library(dplyr)
library(fields) #imageplot
library(maps) #map world
library(raster)
library(RColorBrewer)#color palette
library(readxl)

#SDMTools - install RTools and follow: https://cran.r-project.org/bin/windows/Rtools/
#install.packages("remotes")
#remotes::install_version("SDMTools", "1.1-221.2")
library(SDMTools)
library(dismo)
library(stringr)
```

# Source the function for forward selection of the variables developed by libaibarriaga criterium: AIC and pvalue

```{r}
source(here::here ("scripts", "06_SCGAMs","function_scam_selection_optimized.R"))
```
## preparing data
```{r}
# selecting the variables to be used in the model
vars <- c("temp.v",
          "sal.v",
          "nit.v",
          "dist_seabed.v",
          "mld_relative_position.v",
          "npp.v")
```

## Loading species data occurrences and pseudoabsences 50% of prevalence
```{r}
species <- read.csv (here::here ("data", "derived_data","outputs_for_modelling", "species_for_modelling.csv"),  sep = ",")

species <- species %>% 
  dplyr:: select ( -X) 

names <- read_excel (here::here ("data", "derived_data", "01_species_catches", "fish_and_tuna_long_list_75_Atlantic.xlsx"))

filenames_sp <- names$TaxonName


head(names)

n <- data.frame(species$SP)

names(n)

n <- n %>% 
  dplyr::rename (id = "species.SP")

n <- str_remove(n$id, "SP")

n <- as.numeric (n)

```

Loop to build scams by species with sp = 0.00001 and default k = 8 and plevel  = 0.05
```{r}
for(i in n ){
  
  load(here::here ("data", "derived_data", "outputs_for_modelling", "pa_environment", paste0("SP",i,".Rdata")))
  
  data<-get(paste0("SP",i), env = new.env())
  dat <- data

  
  # apply the model selection function (no limits in the number of terms)
  res <- try(modsel.scam(basef="status ~ 1", vars=vars, dat=dat, sp = 0.00001), silent=T) # by default aic.tol=2
  
  # print message if model with sp NULL is not working 
  if (class(res)=="try-error"){
    print(paste("Model selection did not work for species SP", i))
    
  }else{
  
  # give again the proper name
  assign(paste0("model_SP",i), res)
  
  # save files after removing outliers
  save (list=paste0("model_SP",i), file = here::here ("data", "derived_data" , "models_sp00001", paste0("model_SP",i, ".RData")))
  
  }

}
```

# check results
```{r}
res$svars
sapply(res$smod, AIC)
sapply(res$smod, function(x) summary(x)$dev.expl)
lapply(res$smod, formula)
lapply(res$smod, summary)

model <- res$smod[[length(res$smod)]]
model$sp

# see specifically the summary and the plots of the final model after the selection
# note that it is the last element of the list of models

summary(res$smod[[length(res$smod)]])
scam.check(res$smod[[length(res$smod)]])
plot(res$smod[[length(res$smod)]])
plotmo(res$smod[[length(res$smod)]],level = 0.95, pt.col=8)

```


