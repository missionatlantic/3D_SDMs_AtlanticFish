---
title: "Ploting depth & lat profiles"
author: "M Valle, E RÃ¡mirez-Romero, L Ibaibarriaga"
date: "6/7/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warming = FALSE)
```

### Script information

With this script we plot profiles of habitat suitability along latitude from 0 to 1000 m depth. 

Project: IM-20-MISSION

### Loading required libraries
```{r}
library(tidyverse)# %>%
library(stringr) #str_remove
library(plotly)
library(RColorBrewer)
library(readxl)

theme_set(theme_bw(base_size = 16)) + theme(plot.title = element_text(hjust = 0.5))
```

### Load species SPid and names
```{r}
species <- read.csv (here::here ("data", "derived_data","outputs_for_modelling", "species_for_modelling.csv"),  sep = ",")

species <- species %>% 
  dplyr:: select ( -X) 

names <- read_excel (here::here ("data", "derived_data", "01_species_catches", "fish_and_tuna_long_list_75_Atlantic.xlsx"))

filenames_sp <- names$TaxonName


head(names)

n <- data.frame(species$SP)

names(n)

n <- n %>% 
  dplyr::rename (id = "species.SP")

n <- str_remove(n$id, "SP")

n <- as.numeric (n)

```

#create a vector for depth
```{r}
# define depth levels

load(here::here ("data", "raw_data", "variables", "DEPTH", "depth.RData"))

y <- data.frame(depth)
```

Create a df
```{r}
profiles_stats <-matrix(NA,ncol = 3, nrow = 76)
```

# Loading depth quantile information for the species
```{r}

max_depth_for_hsm <- read.csv (here::here ("data", "derived_data", "models_sp00001", "max_depth_for_hsm_quantile.csv"),  sep = ",")
```

####Plot cummulative probability along latitudinal gradient

With the loop below one plot_ly is created showing the scaled probability value along the latitudinal profile for each species
```{r}
for(i in n){
#i <-11  
  #Load SP data to map occurrences
   load(here::here ("data", "derived_data", "outputs_for_modelling", "pa_environment", paste0("SP",i,".Rdata")))
  
  occ<-get(paste0("SP",i), env = new.env())
  
  # filter to keep only occurrences and rename lon lat columns
  occ <- occ %>% 
    dplyr::filter (status == 1) %>% 
    dplyr::select (lon, lat, depth, status) %>% 
    dplyr::rename (x = "lon", 
            y = "lat")
  
    #select depth limit 
  myquantile <- max_depth_for_hsm %>% 
          filter (max_depth_for_hsm$SP == paste0("SP", i))
  
  depth_limit <- myquantile$quantile_depth + 100

  # Load zsum profile data
  load(file.path("data", "derived_data", "models_sp00001", "lat_profiles", "sum_cumulative_prob", paste0("z_prob_sum_SP",i, ".RData")))
  
  zsum <- get (paste0("zsum_SP",i), env = new.env())

#Scale to 0 to 1 range  
summed_zsum <-  zsum %>% 
    dplyr::select (-zone) %>% 
    dplyr::mutate (hsm_sum = rowSums(., na.rm =TRUE))  

z<-as.matrix(zsum[,2:length(zsum)])
summary(z)
sum(z)

min_z <- min(z)
max_z <- max(z)

x<-(zsum$zone)


z_scaled <- apply(z,1:2, function(x) (x-min(z))/(max_z-min_z))

max(z_scaled)

colnames(z_scaled) <- y$depth
rownames(z_scaled) <- zsum$zone
df <- reshape2::melt(z_scaled, c("Lat","Depth"), value.name="Value")

#https://plotly.com/r/contour-plots/

#colorscale list: Blackbody,Bluered,Blues,Cividis,Earth,Electric,Greens,Greys,Hot,Jet,Picnic,Portland,Rainbow,RdBu,Reds,Viridis,YlGnBu,YlOrRd.

 p <- plot_ly(x=(x),y=-y$depth,z=(t(z_scaled)),type = "contour",
             contours = list(coloring = 'heatmap'),
             colorscale = 'YlOrRd',
             reversescale =T,
             autocontour = F,
            contours = list(start = min (z_scaled, na.rm = TRUE),
                              end = 1,
                              size = 0.05))%>%
   # give to range the values of lat max and min
   layout(xaxis = list(range=c(-83, 90)),yaxis = list(range=c(-depth_limit,0)))%>%
   add_trace(x=~occ$y,y=~-occ$depth, type = "scatter",
             marker = list(size = 3,
                           #color = "rgba(20, 20, 20, .1)"))
                           color = 'rgba(15,10,222, .99)'))

 p<- p %>% layout(title = (paste("SP",i, filenames_sp[i])),
          xaxis = list(title = 'Latitude'),
          yaxis = list(title = 'Depth (m)',
                       range = c(-depth_limit, 0)))

print(p)

#fill in the df

profiles_stats[i,]<- c(paste0("SP",i),
                                      paste0(filenames_sp[i]),
                                      max(df$Value))


}

profiles_stats <- as.data.frame(profiles_stats)

names(profiles_stats) <- c("SP", "SN", "max_prob_lat")

profiles_stats <- profiles_stats %>% 
  drop_na(SP)

write.csv(profiles_stats, file=here::here ("data", "derived_data", "models_sp00001", "lat_profiles", "profiles_stats.csv"))

```



